update property_4326
SET geom=ST_Multi(ST_CollectionExtract(ST_MakeValid(geom), 3))
WHERE NOT ST_IsValid(geom);

update footprints_4326
SET geom=ST_Multi(ST_CollectionExtract(ST_MakeValid(geom), 3))
WHERE NOT ST_IsValid(geom);

create table building_pinnum as
SELECT a.pinnum as pin, b.geom
from property_4326 as a 
join footprints_4326 as b on st_intersects(a.geom,b.geom)
group by a.pinnum, b.geom;

CREATE table parcels_fl1yr_tab AS
SELECT a.pinnum as pin, a.geom
from property_4326 as a 
join fl1yr as b on st_intersects(a.geom,b.geom)
group by a.pinnum, a.geom;

CREATE table parcels_fl5yr_tab AS
SELECT a.pinnum as pin, a.geom
from property_4326 as a 
join fl5yr as b on st_intersects(a.geom,b.geom)
group by a.pinnum, a.geom;

update property_4326
SET geom=ST_Multi(ST_CollectionExtract(ST_MakeValid(geom), 3))
WHERE NOT ST_IsValid(geom);

update footprints_4326
SET geom=ST_Multi(ST_CollectionExtract(ST_MakeValid(geom), 3))
WHERE NOT ST_IsValid(geom);

create table building_pinnum as
SELECT a.pinnum as pin, b.geom
from property_4326 as a 
join footprints_4326 as b on st_intersects(a.geom,b.geom)
group by a.pinnum, b.geom;

CREATE table parcels_fl1yr_tab AS
SELECT a.pinnum as pin, a.geom
from property_4326 as a 
join fl1yr as b on st_intersects(a.geom,b.geom)
group by a.pinnum, a.geom;

CREATE table parcels_fl5yr_tab AS
SELECT a.pinnum as pin, a.geom
from property_4326 as a 
join fl5yr as b on st_intersects(a.geom,b.geom)
group by a.pinnum, a.geom;

CREATE table build_fl1yr_tab AS
SELECT a.pinnum as pin, a.geom
from building_footprints as a 
join fl1yr as b on st_intersects(a.geom,b.geom)
group by a.pinnum, a.geom;

CREATE table build_fl5yr_tab AS
SELECT a.pinnum as pin, a.geom
from building_footprints as a 
join fl5yr as b on st_intersects(a.geom,b.geom)
group by a.pinnum, a.geom;

CREATE table build_fl1yr_simtab AS
SELECT a.pin, a.geom
from building_pinnum as a 
join fl1yr as b on st_intersects(a.geom,b.geom)
group by a.pin, a.geom;

CREATE table build_fl5yr__simtab AS
SELECT a.pin as pin, a.geom
from building_pinnum as a 
join fl5yr as b on st_intersects(a.geom,b.geom)
group by a.pinn, a.geom;

alter table parcel_fl1yr_tab
add column bldg_flood_yn text

alter table parcel_fl1yr_tab 
drop column bldg_flood_yn

update parcel_fl1yr_tab as a
set bldg_flood_yn = (select case when a.pin = b.pin then 'yes' else 
'no' end) from building_fl1yr_tab as b

alter table parcel_fl5yr_tab 
add column YN_bldg_flood text

alter table build_fl5yr_tab 
add column YN_bldg_flood text

update parcel_fl5yr_tab as a
set yes_no = (select case when a.pinnum = b.pinnum then 'yes' else 
'no' end) from building_fl1yr_tab as b



