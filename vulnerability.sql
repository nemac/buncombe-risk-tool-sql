--The creation of the exposure levels and adaptive capacity data table
--This process includes creating the tables intersecting of parcels and features within the 100 and 500 year floodplain
--When the intersection is being ran it pulls out the pinnum geometry building class and building values
--Once the exposued features have been found then a field is added to show whether or not the building within the parcel is also exposed--
--Year built values are then joined to the parcels data gatherinh all the metrics needed to assess vulbnerability-----

drop table if exists building_pinnum cascade;
drop table if exists parcels_fl1yr_tab cascade;
drop table if exists parcels_fl5yr_tab cascade;
drop table if exists build_fl1yr_tab cascade;
drop table if exists build_fl5yr_tab cascade;
---^^^when starting a new database run this query first to clear out old data^^^--

create table building_pinnum_join as
SELECT a.pinnum as pin, b.geom 
from property_4326 as a 
join footprints_4326 as b on st_intersects(a.geom,b.geom)
group by a.pinnum, b.geom;
---^^spatially join the buildings to parcel to associated the building features with a pinnum^^--



CREATE table parcels_fl1yr_tab AS
SELECT a.pinnum as pin, a.geom, sum(a.buildingva), a.class
from property_4326 as a 
join fl1yr as b on st_intersects(a.geom,b.geom)
group by a.pinnum, a.geom, a.class;
--^^Intersect the parcels to the 100 year floodplain^^-----


CREATE table parcels_fl5yr_tab AS
SELECT a.pinnum as pin, a.geom, sum(a.buildingva), a.class
from property_4326 as a 
join fl5yr as b on st_intersects(a.geom,b.geom)
group by a.pinnum, a.geom, a.class;
--^^Intersect the parcels to the 500 year floodplain^^-----

CREATE table build_fl1yr_tab AS
SELECT a.pin, a.geom
from building_pinnum_join as a 
join fl1yr as b on st_intersects(a.geom,b.geom)
group by a.pin, a.geom;
--****2275472 ms to run****--
--^^Intersect the building footprints to the 100 year floodplain^^-----

CREATE table build_fl5yr_tab AS
SELECT a.pin as pin, a.geom
from building_pinnum_join as a 
join fl5yr as b on st_intersects(a.geom,b.geom)
group by a.pin, a.geom;
--****
---^^Intersect the building footprints to the 500 year floodplain^^-------




------Join fields that will be used for the vulnerability rankings-------

---Parcels within 100 year flood plain attribute gathering----------

create or replace view build_par_fl1yr_yn as 
select a.pin, (case when a.pin = b.pin then 'yes' else 
null end) as yes_no from build_fl1yr_tab as a, parcels_fl1yr_tab as b 
where a.pin= b.pin

alter table parcels_fl1yr_tab
add column bldg_fl1yr_yn text,
add column year_built numeric;

update parcels_fl1yr_tab as a
set year_built = b.year_built 
from year_built_com as b 
where a.pin = b.pinnum;

update parcels_fl1yr_tab as a
set year_built = b.year_built 
from year_built_res as b 
where a.pin = b.pinnum; 

update parcels_fl1yr_tab as a 
set bldg_fl1yr_yn = b.yes_no 
from build_par_fl1yr_yn as b
where a.pin = b.pin


---Parcels within 500 year flood plain attribute gathering----------

create or replace view build_par_fl5yr_yn as 
select a.pin, (case when a.pin = b.pin then 'yes' else 
null end) as yes_no from build_fl5yr_tab as a, parcels_fl5yr_tab as b 
where a.pin= b.pin

alter table parcels_fl5yr_tab 
add column bldg_fl5yr_yn text,
add column year_built numeric;

update parcels_fl5yr_tab as a
set year_built = b.year_built 
from year_built_com as b 
where a.pin = b.pinnum;

update parcels_fl5yr_tab as a
set year_built = b.year_built 
from year_built_res as b 
where a.pin = b.pinnum; 

update parcels_fl5yr_tab as a 
set bldg_fl5yr_yn = b.yes_no 
from build_par_fl5yr_yn as b
where a.pin = b.pin;


--------Begin the creation of the vulerability ranks of 1-9 given the exposure and adaptive capcity metrics-------------

alter table parcels_fl1yr_tab 
add column exposure_levels text,
add column adcap_levels text,
add column vuln_levels text;

create or replace fl1yr_exposure as 
select a.pin, 
(case
when a.bldg_fl1yr_yn <> 'yes' then 'Low'
when a.bldf_fl1yr_yn = 'yes' and class <> 117 or class <> 411 or class <> 420 then 'Med'
when a.bldf_fl1yr_yn = 'yes' and class = 117 or class = 411 or class = 420 then 'High' 
else 'Not enough data' END) as exposure_levels,
a.geom from parcels_fl1yr_tab as a;

create or replace fl1yr_adcap as 
select a.pin, 
(case 
when a.year_built < 1981 and sum < 120000 then 'Low'
when a.year_built < 1981 and sum > 120000 then 'Med'
when a.year_built > 1981 and sum > 120000 then 'High' 
else 'Not enough data' END) as adcap_levels,
a.geom, from parcels_fl1yr_adcap as a;
		
create or replace fl1yr_vuln as 
select a.pin, 
(case 
when exposure_levels = 'Low' and adcap_levels = 'Low' then '1'
when exposure_levels = 'Low' and adcap_levels = 'Med'  then '2'
when exposure_levels = 'Low' and adcap_levels = 'High'  then '3'
when exposure_levels = 'Med' and adcap_levels = 'Low'  then '4'
when exposure_levels = 'Med' and adcap_levels = 'Med'  then '5'
when exposure_levels = 'Med' and adcap_levels = 'High'  then '6'
when exposure_levels = 'High' and adcap_levels = 'Low'  then '7'
when exposure_levels = 'High' and adcap_levels = 'Med'  then '8'
when exposure_levels = 'High' and adcap_levels = 'High'  then '9'
ELSE 'Not enough data' END) as vuln_levels, a.geom from parcles_fl1yr_tab;


create or replace fl5yr_exposure as 
select a.pin, 
(case 
when a.bldg_fl1yr_yn <> 'yes' then 'Low'
when a.bldf_fl1yr_yn = 'yes' and class <> 117 or class <> 411 or class <> 420 then 'Med'
when a.bldf_fl1yr_yn = 'yes' and class = 117 or class = 411 or class = 420 then 'High' 
else 'Not enough data' END) as exposure_levels,
a.geom from parcels_fl5yr_tab as a;

create or replace fl5yr_adcap as 
select a.pin, 
(case 
when a.year_built < 1981 and sum < 120000 then 'Low'
when a.year_built < 1981 and sum > 120000 then 'Med'
when a.year_built > 1981 and sum > 120000 then 'High' 
else 'Not enough data' END) as adcap_levels,
a.geom, from parcels_fl5yr_adcap as a;
		
create or replace view fl5yr_vuln as 
select a.pin, 
(case 
when exposure_levels = 'Low' and adcap_levels = 'Low' then '1'
when exposure_levels = 'Low' and adcap_levels = 'Med'  then '2'
when exposure_levels = 'Low' and adcap_levels = 'High'  then '3'
when exposure_levels = 'Med' and adcap_levels = 'Low'  then '4'
when exposure_levels = 'Med' and adcap_levels = 'Med'  then '5'
when exposure_levels = 'Med' and adcap_levels = 'High'  then '6'
when exposure_levels = 'High' and adcap_levels = 'Low'  then '7'
when exposure_levels = 'High' and adcap_levels = 'Med'  then '8'
when exposure_levels = 'High' and adcap_levels = 'High'  then '9'
ELSE 'Not enough data' END) as vuln_levels, a.geom from parcles_fl5yr_tab;
