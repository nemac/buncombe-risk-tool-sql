create extension tablefunc;
drop table if exists road_flood_bg_tab;
drop table if exists road_flood_classification;

create or replace view road_flood as 
select a.* from streets_buncombe as a 
join fl1yr as b 
on ST_intersects(a.geom, b.geom);

create table road_flood_bg_tab as 
select a.gid, a.road_class as class, (ST_Length(ST_Transform(a.geom, 2877))/5280) as miles, b.blkgrpce as bg_id from road_flood as a 
join nc_cblockgroups as b 
on st_intersects(a.geom, b.geom);

create table road_flood_classification as
select gid, class, sum(miles) from road_flood_bg_tab
group by class, gid;

alter table road_flood_classification 
add column bg_id character varying(1)

update road_flood_classification as a 
set bg_id = b.bg_id from road_flood_bg_tab as b
where a.gid = b.gid

select sum(miles), road_class from (select sum(sum) as miles, class as road_class, bg_id 
from road_flood_classification as b
group by bg_id, class) as  b
group by road_class
order by class asc;

select sum(sum), bg_id
from road_flood_classification 
group by bg_id;

